From 8aa123535d098039426dd41c5890f4216807464a Mon Sep 17 00:00:00 2001
From: John Clark <inindev@gmail.com>
Date: Sun, 21 May 2023 17:53:40 -0400
Subject: [PATCH 13/16] patch for u-boot v2023.04 spi mode quad read

Signed-off-by: John Clark <inindev@gmail.com>
---
 arch/arm/dts/rk3568-odroid-m1-u-boot.dtsi | 35 +++++++++++------------
 configs/odroid-m1-rk3568_defconfig        | 11 +++----
 2 files changed, 23 insertions(+), 23 deletions(-)

diff --git a/arch/arm/dts/rk3568-odroid-m1-u-boot.dtsi b/arch/arm/dts/rk3568-odroid-m1-u-boot.dtsi
index a994dd9c5a..5ef74fa5af 100644
--- a/arch/arm/dts/rk3568-odroid-m1-u-boot.dtsi
+++ b/arch/arm/dts/rk3568-odroid-m1-u-boot.dtsi
@@ -12,60 +12,59 @@
 
 	chosen {
 		stdout-path = &uart2;
-		u-boot,spl-boot-order = "same-as-spl", &sdmmc0, &sdhci;
 	};
 };
 
 &emmc_bus8 {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &emmc_clk {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &emmc_cmd {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &emmc_datastrobe {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &fspi_dual_io_pins {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &pinctrl {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &pcfg_pull_none {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &pcfg_pull_up_drv_level_2 {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &pcfg_pull_up {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &sdmmc0_bus4 {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &sdmmc0_clk {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &sdmmc0_cmd {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &sdmmc0_det {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &sdhci {
@@ -78,20 +77,20 @@
 };
 
 &sfc {
-	bootph-pre-ram;
+	u-boot,dm-spl;
 	u-boot,spl-sfc-no-dma;
 
 	flash@0 {
-		bootph-pre-ram;
+		u-boot,dm-spl;
 	};
 };
 
 &uart2m0_xfer {
-	bootph-all;
+	u-boot,dm-pre-reloc;
 };
 
 &uart2 {
 	clock-frequency = <24000000>;
-	bootph-all;
+	u-boot,dm-pre-reloc;
 	status = "okay";
 };
diff --git a/configs/odroid-m1-rk3568_defconfig b/configs/odroid-m1-rk3568_defconfig
index f4ed4eeab2..fe877d90e1 100644
--- a/configs/odroid-m1-rk3568_defconfig
+++ b/configs/odroid-m1-rk3568_defconfig
@@ -8,8 +8,6 @@ CONFIG_SPL_LIBGENERIC_SUPPORT=y
 CONFIG_NR_DRAM_BANKS=2
 CONFIG_HAS_CUSTOM_SYS_INIT_SP_ADDR=y
 CONFIG_CUSTOM_SYS_INIT_SP_ADDR=0xc00000
-CONFIG_SF_DEFAULT_SPEED=24000000
-CONFIG_SF_DEFAULT_MODE=0x1000
 CONFIG_DEFAULT_DEVICE_TREE="rk3568-odroid-m1"
 CONFIG_ROCKCHIP_RK3568=y
 CONFIG_SPL_ROCKCHIP_COMMON_BOARD=y
@@ -23,13 +21,13 @@ CONFIG_DEBUG_UART_CLOCK=24000000
 CONFIG_SPL_SPI_FLASH_SUPPORT=y
 CONFIG_SPL_SPI=y
 CONFIG_SYS_LOAD_ADDR=0xc00800
-CONFIG_PCI=y
 CONFIG_DEBUG_UART=y
 CONFIG_FIT=y
 CONFIG_FIT_VERBOSE=y
 CONFIG_SPL_FIT_SIGNATURE=y
 CONFIG_SPL_LOAD_FIT=y
-CONFIG_DEFAULT_FDT_FILE="rockchip/rk3568-odroid-m1.dtb"
+CONFIG_LEGACY_IMAGE_FORMAT=y
+CONFIG_DEFAULT_FDT_FILE="rk3568-odroid-m1.dtb"
 # CONFIG_DISPLAY_CPUINFO is not set
 CONFIG_DISPLAY_BOARDINFO_LATE=y
 CONFIG_SPL_MAX_SIZE=0x40000
@@ -41,7 +39,7 @@ CONFIG_SPL_BSS_MAX_SIZE=0x4000
 # CONFIG_SPL_SHARES_INIT_SP_ADDR is not set
 CONFIG_SPL_STACK_R=y
 CONFIG_SPL_SPI_LOAD=y
-CONFIG_SYS_SPI_U_BOOT_OFFS=0x60000
+CONFIG_SYS_SPI_U_BOOT_OFFS=0x100000
 CONFIG_SPL_ATF=y
 CONFIG_CMD_GPIO=y
 CONFIG_CMD_GPT=y
@@ -68,10 +66,13 @@ CONFIG_MMC_DW_ROCKCHIP=y
 CONFIG_MMC_SDHCI=y
 CONFIG_MMC_SDHCI_SDMA=y
 CONFIG_MMC_SDHCI_ROCKCHIP=y
+CONFIG_SF_DEFAULT_MODE=0x2000
+CONFIG_SF_DEFAULT_SPEED=24000000
 CONFIG_SPI_FLASH_MACRONIX=y
 CONFIG_ETH_DESIGNWARE=y
 CONFIG_GMAC_ROCKCHIP=y
 CONFIG_NVME_PCI=y
+CONFIG_PCI=y
 CONFIG_PCIE_DW_ROCKCHIP=y
 CONFIG_PHY_ROCKCHIP_INNO_USB2=y
 CONFIG_PHY_ROCKCHIP_NANENG_COMBOPHY=y
-- 
2.39.2

